<?php session_start(); require_once __DIR__.'/../config/db.php'; if(!isset($_SESSION['user_id'])) header('Location: login.php'); $cart=$_SESSION['cart']??[]; if(empty($cart)) header('Location: cart.php'); $total=floatval($_POST['total']); $pm=$_POST['payment_method']??'COD'; $payfile=null; if(!empty($_FILES['payment_screenshot']['name'])){ if(!is_dir(__DIR__.'/../assets/images/payments')) mkdir(__DIR__.'/../assets/images/payments',0755,true); $ext=pathinfo($_FILES['payment_screenshot']['name'],PATHINFO_EXTENSION); $new='assets/images/payments/'.time().'_pay.'.$ext; move_uploaded_file($_FILES['payment_screenshot']['tmp_name'], __DIR__.'/../'.$new); $payfile=$new; } $stmt=$conn->prepare('INSERT INTO orders (user_id,total_amount,payment_method,payment_screenshot,status) VALUES (?,?,?,?,"Placed")'); $stmt->bind_param('idss', $_SESSION['user_id'],$total,$pm,$payfile); $stmt->execute(); $order_id=$stmt->insert_id; foreach($cart as $it){ $ins=$conn->prepare('INSERT INTO order_items (order_id,item_name,price,qty) VALUES (?,?,?,?)'); $ins->bind_param('isdi',$order_id,$it['name'],$it['price'],$it['qty']); $ins->execute(); } unset($_SESSION['cart']); header('Location: order_status.php?id='.$order_id); exit; ?>